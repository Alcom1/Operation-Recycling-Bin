{
  "version": 3,
  "sources": ["C:\\Users\\Alcom\\Desktop\\Dev\\Git\\Operation Recycling Bin\\src\\game\\gameobjects\\character.ts"],
  "sourcesContent": ["import Engine from \"engine/engine\";\r\nimport Scene from \"engine/scene/scene\";\r\nimport GameObject, { GameObjectParams } from \"engine/gameobjects/gameobject\";\r\nimport { getZIndex, GMULTX, GMULTY } from \"engine/utilities/math\";\r\nimport Vect from \"engine/utilities/vect\";\r\nimport BrickHandler from \"./brickhandler\";\r\nimport Brick from \"./bricknormal\";\r\nimport Animat, { OffsetImageParams, AnimationParams } from \"./animation\";\r\n\r\nexport interface CharacterParams extends GameObjectParams {\r\n    height? : number;\r\n    speed? : number;\r\n    images : OffsetImageParams[];\r\n    frameCount : number;\r\n    animsCount : number;\r\n}\r\n\r\nexport default class Character extends GameObject {\r\n\r\n    private level!: Scene;\r\n    private speed: number;\r\n    protected _height: number;\r\n    public get height() { return this._height; }\r\n    protected move: Vect;\r\n    protected brickHandler!: BrickHandler;\r\n    private underBricks: Brick[] = [];\r\n    protected checkCollision: boolean;\r\n\r\n    protected spriteGroupIndex = 0;\r\n    protected spriteGroups: Animat[][] = [[]];\r\n    protected get spriteGroupCurr() : Animat[] { return this.spriteGroups[this.spriteGroupIndex] }\r\n    protected get isNormalMovment() : boolean { return this.spriteGroupIndex == 0 }\r\n\r\n    constructor(engine: Engine, params: CharacterParams) {\r\n        super(engine, params);\r\n\r\n        this.tags.push(\"Character\");        //All characters need to share a tag\r\n        \r\n        this.speed = params.speed ?? 1;     //Default speed\r\n        this.move = new Vect(1, 0);         //Default move directions\r\n        this._height = params.height ?? 2;  //Default height for a character\r\n        this.checkCollision = true;\r\n\r\n        //Spawn 3 animations, the sprite is sliced vertically into 2x wide segments for proper z-indexing\r\n        for(let i = -1; i <= 1; i ++) {\r\n\r\n            //Generate segment\r\n            const segment = new Animat(this.engine, {\r\n                ...params, \r\n                sliceIndex : i,\r\n                framesSize : GMULTX * 2,\r\n                gposOffset : { x : -1, y : 0 }\r\n            } as AnimationParams);\r\n            this.spriteGroupCurr.push(segment);\r\n            \r\n            // Add segment game object to scene\r\n            this.parent.pushGO(segment);\r\n        }\r\n    }\r\n\r\n    public init(ctx: CanvasRenderingContext2D, scenes: Scene[]) {\r\n\r\n        // Get level.\r\n        const level = scenes.find(s => s.name == \"Level\");\r\n        if (!level) throw new Error(\"Can't find level\");\r\n        this.level = level;\r\n\r\n        // Get brickhandler for pressure checks\r\n        this.brickHandler = this.engine.tag.get(\"BrickHandler\", \"LevelInterface\")[0] as BrickHandler;\r\n\r\n        // Set active groups\r\n        this.setCurrentGroup();\r\n    }\r\n\r\n    public update(dt: number) {\r\n\r\n        //Normal or unique movement\r\n        if(this.isNormalMovment) {\r\n            this.handleNormalMovement(dt);\r\n        }\r\n        else {\r\n            this.handleUniqueMovmeent(dt);\r\n        }\r\n\r\n        //Handle collision, set zIndices for new position\r\n        if(this.checkCollision) {\r\n\r\n            this.handleCollision();\r\n            this.handleBricks();\r\n\r\n            this.spriteGroupCurr.forEach(s => s.updateSprite(this.gpos));\r\n            this.level.sortGO();\r\n\r\n            this.checkCollision = false;\r\n        }\r\n    }\r\n\r\n    //Move forward and set collection check at each step.\r\n    private handleNormalMovement(dt: number) {\r\n\r\n        //Increment position by speed\r\n        this.spos.x += this.move.x * this.speed * GMULTX * dt;\r\n\r\n        //Step grid position further once subposition goes past a grid-unit\r\n        if (Math.abs(this.spos.x) > GMULTX) {\r\n\r\n            var dir = Math.sign(this.spos.x);\r\n\r\n            this.spos.x -= GMULTX * dir;\r\n            this.gpos.x += dir;\r\n\r\n            this.checkCollision = true;\r\n        }\r\n    }\r\n\r\n    //Do nothing - override\r\n    protected handleUniqueMovmeent(dt: number) {\r\n\r\n    }\r\n\r\n    //Manage bricks underneath this character, set pressure\r\n    private handleBricks() {\r\n\r\n        //Reset pressures\r\n        this.underBricks.forEach(b => b.pressure -= 1);\r\n\r\n        //Get new set of bricks for pressures\r\n        this.underBricks = this.brickHandler.checkCollisionRow(\r\n            this.gpos.getAdd({x : -1, y : 1}), \r\n            2);\r\n\r\n        //Set new pressures\r\n        this.underBricks.forEach(b => b.pressure += 1);\r\n        this.brickHandler.isPressured = true;\r\n    }\r\n\r\n    //Do nothing - override\r\n    protected handleCollision() {\r\n\r\n    }\r\n\r\n    //Reverse the direction of this character\r\n    protected reverse() {\r\n\r\n        this.move.x *= -1;\r\n        this.gpos.x += this.move.x;\r\n        this.spriteGroups[0].forEach(x => x.setImageIndex(this.move.x));\r\n    }\r\n\r\n    //Set current & active group based on the group index\r\n    protected setCurrentGroup(index? : number) {\r\n        \r\n        index = index ?? this.spriteGroupIndex;\r\n        this.spriteGroupIndex = index;\r\n        this.spriteGroups.forEach((sg, i) => sg.forEach(s => {\r\n            s.isActive = i == index;\r\n            s.updateSprite(this.gpos);\r\n        }));\r\n    }\r\n\r\n    //Deactivate this gameObject\r\n    public deactivate() {\r\n        this.isActive = false;\r\n        this.spriteGroups.forEach(sg => sg.forEach(s => s.isActive = false));\r\n        this.underBricks.forEach(b => b.pressure -= 1);\r\n        this.underBricks = [];\r\n    }\r\n}\r\n"],
  "mappings": "AAEA;AACA;AACA;AAGA;AAPA,uCAiBuC;AAAA,EAgBnC,YAAY;AACR,UAAM,SAAQ;AATV,uBAAuB;AAGrB,4BAAmB;AACnB,wBAA2B,CAAC;AAOlC,SAAK,KAAK,KAAK;AAEf,SAAK,QAAQ,OAAO,SAAS;AAC7B,SAAK,OAAO,IAAI,KAAK,GAAG;AACxB,SAAK,UAAU,OAAO,UAAU;AAChC,SAAK,iBAAiB;AAGtB,iBAAY,IAAI,KAAK,GAAG;AAGpB,sBAAgB,IAAI,OAAO,KAAK,QAAQ;AAAA,WACjC;AAAA,QACH,YAAa;AAAA,QACb,YAAa,SAAS;AAAA,QACtB,YAAa,CAAE,GAAI,IAAI,GAAI;AAAA;AAE/B,WAAK,gBAAgB,KAAK;AAG1B,WAAK,OAAO,OAAO;AAAA;AAAA;AAAA,MAlChB;AAAW,WAAO,KAAK;AAAA;AAAA,MAQpB;AAA+B,WAAO,KAAK,aAAa,KAAK;AAAA;AAAA,MAC7D;AAA8B,WAAO,KAAK,oBAAoB;AAAA;AAAA,EA6BrE;AAGH,kBAAc,OAAO,KAAK,OAAK,EAAE,QAAQ;AACzC,QAAI,CAAC;AAAO,YAAM,IAAI,MAAM;AAC5B,SAAK,QAAQ;AAGb,SAAK,eAAe,KAAK,OAAO,IAAI,IAAI,gBAAgB,kBAAkB;AAG1E,SAAK;AAAA;AAAA,EAGF;AAGH,QAAG,KAAK;AACJ,WAAK,qBAAqB;AAAA;AAG1B,WAAK,qBAAqB;AAAA;AAI9B,QAAG,KAAK;AAEJ,WAAK;AACL,WAAK;AAEL,WAAK,gBAAgB,QAAQ,OAAK,EAAE,aAAa,KAAK;AACtD,WAAK,MAAM;AAEX,WAAK,iBAAiB;AAAA;AAAA;AAAA,EAKtB;AAGJ,SAAK,KAAK,KAAK,KAAK,KAAK,IAAI,KAAK,QAAQ,SAAS;AAGnD,QAAI,KAAK,IAAI,KAAK,KAAK,KAAK;AAExB,gBAAU,KAAK,KAAK,KAAK,KAAK;AAE9B,WAAK,KAAK,KAAK,SAAS;AACxB,WAAK,KAAK,KAAK;AAEf,WAAK,iBAAiB;AAAA;AAAA;AAAA,EAKpB;AAAA;AAAA,EAKF;AAGJ,SAAK,YAAY,QAAQ,OAAK,EAAE,YAAY;AAG5C,SAAK,cAAc,KAAK,aAAa,kBACjC,KAAK,KAAK,OAAO,CAAC,GAAI,IAAI,GAAI,KAC9B;AAGJ,SAAK,YAAY,QAAQ,OAAK,EAAE,YAAY;AAC5C,SAAK,aAAa,cAAc;AAAA;AAAA,EAI1B;AAAA;AAAA,EAKA;AAEN,SAAK,KAAK,KAAK;AACf,SAAK,KAAK,KAAK,KAAK,KAAK;AACzB,SAAK,aAAa,GAAG,QAAQ,OAAK,EAAE,cAAc,KAAK,KAAK;AAAA;AAAA,EAItD;AAEN,YAAQ,SAAS,KAAK;AACtB,SAAK,mBAAmB;AACxB,SAAK,aAAa,QAAQ,WAAW,GAAG,QAAQ;AAC5C,QAAE,WAAW,KAAK;AAClB,QAAE,aAAa,KAAK;AAAA;AAAA;AAAA,EAKrB;AACH,SAAK,WAAW;AAChB,SAAK,aAAa,QAAQ,QAAM,GAAG,QAAQ,OAAK,EAAE,WAAW;AAC7D,SAAK,YAAY,QAAQ,OAAK,EAAE,YAAY;AAC5C,SAAK,cAAc;AAAA;AAAA;",
  "names": []
}
